/*
 * Main CAmkES file of the Network Filter Demo
 *
 * Copyright (C) 2021, HENSOLDT Cyber GmbH
 */

import <std_connector.camkes>;

#include "system_config.h"

import "components/Ticker/Ticker.camkes";
import "components/FilterListener/FilterListener.camkes";

#include "os_network_stack/network_stack.camkes"

NwStack_COMPONENT_DEFINE(
    NwStack1,
    NIC_DRIVER_RINGBUFFER_SIZE,
    NETWORK_STACK_1_NUM_SOCKETS,
    NwStack_NO_ADDITIONAL_INTERFACES)

#include "TimeServer/camkes/TimeServer.camkes"
TimeServer_COMPONENT_DEFINE(TimeServer)

// Include the platform specific components and macros.
#include "plat_nic.camkes"

assembly {
    composition {

        //----------------------------------------------------------------------
        // NIC Drivers
        //----------------------------------------------------------------------
        FILTER_DEMO_NIC_INSTANCES(nwDriver1)

        //----------------------------------------------------------------------
        // TimeServer
        //----------------------------------------------------------------------
        component TimeServer timeServer;

        TimeServer_INSTANCE_CONNECT_CLIENTS(
            timeServer,
            ticker.timeServer_rpc,   ticker.timeServer_notify,
            nwStack1.timeServer_rpc, nwStack1.timeServer_notify
        )

        //----------------------------------------------------------------------
        // Ticker
        //----------------------------------------------------------------------
        component Ticker ticker;

        //----------------------------------------------------------------------
        // NwStack
        //----------------------------------------------------------------------
        component NwStack1 nwStack1;

        NwStack_INSTANCE_CONNECT(
            nwStack1,
            ticker.e_timeout_nwstacktick1,
            nwDriver1
        )

        //----------------------------------------------------------------------
        // Filter Listener
        //----------------------------------------------------------------------
        component FilterListener filterListener;

        NwStack_INSTANCE_CONNECT_CLIENT(
            nwStack1,
            filterListener,
            networkStack_rpc,
            // Since the Listener will handle incoming connections, it requires
            // a minimum of two sockets.
            socket_1_port,
            socket_2_port)
    }
    configuration {
        TimeServer_CLIENT_ASSIGN_BADGES(
            ticker.timeServer_rpc,
            nwStack1.timeServer_rpc
        )
        // Platform specific configuration.
        FILTER_DEMO_NIC_CONFIG(nwDriver1)
    }
}
