/*
 * Main CAmkES file of the demo TLS Server
 *
 * Copyright (C) 2021, HENSOLDT Cyber GmbH
 */

import <std_connector.camkes>;

#include "system_config.h"

import "components/Ticker/Ticker.camkes";
import "components/TlsServer/TlsServer.camkes";

#include "os_network_stack/network_stack.camkes"

NwStack_COMPONENT_DEFINE(
    NwStack,
    NIC_DRIVER_RINGBUFFER_SIZE,
    NETWORK_STACK_NUM_SOCKETS,
    NwStack_NO_ADDITIONAL_INTERFACES)

#include "TimeServer/camkes/TimeServer.camkes"
TimeServer_COMPONENT_DEFINE(TimeServer)

// Include the platform specific components and macros.
#include "plat_nic.camkes"

assembly {
    composition {

        //----------------------------------------------------------------------
        // NIC Drivers
        //----------------------------------------------------------------------
        TLS_SERVER_NIC_INSTANCES(nwDriver)

        //----------------------------------------------------------------------
        // TimeServer
        //----------------------------------------------------------------------
        component TimeServer timeServer;

        TimeServer_INSTANCE_CONNECT_CLIENTS(
            timeServer,
            ticker.timeServer_rpc,   ticker.timeServer_notify,
            nwStack.timeServer_rpc, nwStack.timeServer_notify
        )

        //----------------------------------------------------------------------
        // Ticker
        //----------------------------------------------------------------------
        component Ticker ticker;

        //----------------------------------------------------------------------
        // NwStack
        //----------------------------------------------------------------------
        component NwStack nwStack;

        NwStack_INSTANCE_CONNECT(
            nwStack,
            ticker.e_timeout_nwstacktick,
            nwDriver
        )

        //----------------------------------------------------------------------
        // TLS Server
        //----------------------------------------------------------------------
        component TlsServer tlsServer;

        NwStack_INSTANCE_CONNECT_CLIENT(
            nwStack,
            tlsServer,
            networkStack_rpc,
            // Since the Listener will handle incoming connections, it requires
            // a minimum of two sockets.
            socket_1_port,
            socket_2_port)
    }
    configuration {
        TimeServer_CLIENT_ASSIGN_BADGES(
            ticker.timeServer_rpc,
            nwStack.timeServer_rpc
        )
        // Platform specific configuration.
        TLS_SERVER_NIC_CONFIG(nwDriver)
    }
}
